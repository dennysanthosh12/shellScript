

trigger:
  branches:
    include:
    - refs/heads/SIT
    - refs/heads/UAT
    - refs/heads/DEV
    - refs/heads/PRE-PROD
    - refs/heads/main



stages:
# ============== Validation and Initilization ============
- stage: Validation_Stage
  displayName: Validation and Intialization
  pool:
    name: TFS-RH-1
  jobs:
    - job: Validation_Job
      displayName: Validation
      steps:

        - checkout: self

        - task: CmdLine@2
          name: val_task
          env:
            BRANCH: $(Build.SourceBranchName)
          displayName: Validating repository
          inputs:
            script: |
              set -e

              config_path=$(Build.SourcesDirectory)/Config/config.yml
              if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
                echo "ERROR: config.yml not found"
                exit 1
              fi

              REQUIRED_FIELDS=(
                ApplicationName
                IntegrationNode
                IntegrationServer
              )
              for field in "${REQUIRED_FIELDS[@]}"; do
                value=$(yq e ".$BRANCH.$field // \"\"" "$config_path" | tr -d '[:space:]')
                if [ -z "$value" ]; then
                  echo " ERROR: $field is missing or empty for branch $BRANCH in config.yml"
                  exit 1
                fi
              done

              DEPLOY=$(yq e ".$BRANCH.Deploy // true" "$config_path" | tr -d '[:space:]')
              CACHE_PRESENT=$(yq e ".$BRANCH.Cache // [] | length > 0" "$config_path" | tr -d '[:space:]')
              echo "CACHE: $CACHE_PRESENT DEPLOY: $DEPLOY"
              if [ "$DEPLOY" = true ] || [ "$DEPLOY" = "true" ]; then
                DEPLOY="true"
              else
                DEPLOY="false"
              fi
              if [ "$CACHE_PRESENT" = true ] || [ "$CACHE_PRESENT" = "true" ]; then
                CACHE_PRESENT="true"
              else
                CACHE_PRESENT="false"
              fi

              if [ "$DEPLOY" != true ] && [ "$DEPLOY" != false ]; then
                echo "Invalid Deploy flag in config.yml"
                exit 1
              fi

              echo "##vso[task.setvariable variable=DeployFlag;isOutput=true]$DEPLOY"
              echo "##vso[task.setvariable variable=CacheFlag;isOutput=true]$CACHE_PRESENT"


        - task: PublishBuildArtifacts@1
          condition: eq(variables['val_task.DeployFlag'], false)
          inputs:
            PathtoPublish: $(build.sourcesDirectory)/Config/
            ArtifactName: drop
                   

# ================= BUILD STAGE =================
- stage: Build
  displayName: Build Stage
  dependsOn: Validation_Stage
  pool:
    name: TFS-RH-1
  condition: |
    and(
        succeeded('Validation_Stage'),
        eq(
          dependencies.Validation_Stage.outputs['Validation_Job.val_task.DeployFlag'],
          'true'
        )
      )
  jobs:
    - job: Build_Job
      displayName: Agent Build job 
      steps:

        - checkout: self

        - task: CmdLine@2
          displayName: Building Bar file
          env:
            BRANCH: $(Build.SourceBranchName)
          inputs:
            script: |
              set -e
              . /opt/IBM/ace/server/bin/mqsiprofile
              
              config_path=$(Build.SourcesDirectory)/Config/config.yml
              applicationName=$(yq e ".$BRANCH.ApplicationName" "$config_path")
              override_path=$(find . -iname "override.properties")

              if [ -f "$override_path" ]; then
                ibmint package --input-path $(Build.SourcesDirectory) \
                               --output-bar-file $(Build.BinariesDirectory)/$applicationName.bar \
                               --java-version 8 \
                               --overrides-file "$override_path"
              else
                ibmint package --input-path $(Build.SourcesDirectory) \
                               --output-bar-file $(Build.BinariesDirectory)/$applicationName.bar \
                               --java-version 8
              fi

              yq ".$BRANCH.Overrides | to_entries[] | \"\(.key) \(.value)\"" "$config_path" | while read key value;
              do [ -z "$key" ] && continue;
              mqsiapplybaroverride  -b $(Build.BinariesDirectory)/"$applicationName".bar -k "$applicationName" -m "gen.$applicationName#$key=$value";
              done

              cp "$config_path" $(Build.BinariesDirectory)
        
        - task: CopyFiles@2
          inputs:
            SourceFolder: $(Build.BinariesDirectory)
            TargetFolder: $(Build.ArtifactStagingDirectory)
            OverWrite: true

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: $(Build.ArtifactStagingDirectory)
            ArtifactName: drop


# ================= RELEASE STAGE =================
- stage: Release
  displayName: Deploy Stage
  pool:
    name: TFS-RH-1
  dependsOn: Build
  condition: |
    and(
      succeeded('Build'),
      eq(
          dependencies.Validation_Stage.outputs['Validation_Job.val_task.DeployFlag'],
          'true'
        )
    )
  jobs:
    - deployment: DeployApp
      displayName: Deployment Job
      environment: $(Build.SourceBranchName)
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: drop

              - task: CmdLine@2
                displayName: Deploying Bar File
                env:
                  BRANCH: $(Build.SourceBranchName)
                inputs:
                  workingDirectory: $(Pipeline.Workspace)/drop
                  script: |
                    set -e
                    . /opt/IBM/ace/server/bin/mqsiprofile

                    IntegrationNode=$(yq e ".$BRANCH.IntegrationNode" config.yml)
                    ApplicationName=$(yq e ".$BRANCH.ApplicationName" config.yml)
                    IntegrationServer=$(yq e ".$BRANCH.IntegrationServer" config.yml)

                    for broker_file in /home/devops/broker/$BRANCH/$IntegrationNode*; do
                      cat "$broker_file" |grep host| awk -F"\"" '{print "HOST: " $4 " , " "IntegrationNode: " $6}'
                      ibmint deploy \
                        --input-bar-file "$ApplicationName.bar" \
                        --integration-node-file "$broker_file" \
                        --output-server "$IntegrationServer"
                    done

# ================= CACHE STAGE =================
- stage: Cache
  displayName: CACHE
  pool:
    name: TFS-RH-1
  dependsOn: 
    - Validation_Stage
    - Build
  condition: |
    and(
      succeeded('Validation_Stage'),
      eq(
          dependencies.Validation_Stage.outputs['Validation_Job.val_task.CacheFlag'],
          'true'
        ),
      or(
        eq(
          dependencies.Validation_Stage.outputs['Validation_Job.val_task.DeployFlag'],
          'true'
        ),
        succeeded('Build')
      )
    )
  jobs:
    - job: Cache_Job
      displayName: CACHE UPDATE
      steps:
        
        - download: current
          artifact: drop

        - task: CmdLine@2
          displayName: Update cache in Database
          env:
            BRANCH: $(Build.SourceBranchName)
          inputs:
            workingDirectory: $(Pipeline.Workspace)/drop/
            script: |
              source ~/.bashrc
              set -e
              if [ ! -f config.yml ];
              then echo "config.yml file was not found !!"; exit 1;
              fi
              yq ".$BRANCH.Cache[].Query" config.yml | while  IFS= read -r SQL;
              do echo "---------------------------------------------------------";
              echo "Executing SQL Cache Query";
              echo "$SQL";
              echo "---------------------------------------------------------";
              OUTPUT=$(echo "$SQL" | isql "$BRANCH" "$DB_USER" "$DB_PASS" 2>&1);
              STATUS=$?;
              if [[ $STATUS -eq 0 ]] && echo "$OUTPUT" | grep -qi "SQLRowCount";
              then echo "SUCCESS: Query executed";
              else echo "FAILED: Query did not execute"; exit 1;
              fi;
              echo " ";
              done

        - task: CmdLine@2
          displayName: Update Cache in Server
          env:
            BRANCH: $(Build.SourceBranchName)
          inputs:
            workingDirectory: $(Pipeline.Workspace)/drop/
            script: |
              set -e

              IntegrationNode=$(yq ".$BRANCH.IntegrationNode" config.yml)
              for broker_file in /home/devops/broker/$BRANCH/$IntegrationNode*; do
                host=$(cat "$broker_file" | grep host | cut -d"\"" -f4)
                if yq -e ".$BRANCH.Cache" config.yml >/dev/null 2>&1; then
                  response=$(curl -s -k -X POST http://"$host":8002/cache/v1/loadCache \
                  -H "Content-Type: application/json" \
                  -d "$(yq -o=json ".$BRANCH.Cache | map({\"FIELD_NAME\": .FIELD_NAME, \"FIELD_VALUE\": .FIELD_VALUE})" config.yml)")
                  if [[ "$response" != *'"RESPONSE":"success"'* ]]; then
                    echo "Cache load failed: $response"
                    exit 1
                  fi
                  echo "Cache load successful on $host"
                  echo "$(yq -o=json ".$BRANCH.Cache | map({\"FIELD_NAME\": .FIELD_NAME, \"FIELD_VALUE\": .FIELD_VALUE})" config.yml)"
                fi
              done








Validating repository

View raw log

Starting: Validating repository
==============================================================================
Task         : Command line
Description  : Run a command line script using Bash on Linux and macOS and cmd.exe on Windows
Version      : 2.231.0
Author       : Microsoft Corporation
Help         : https://docs.microsoft.com/azure/devops/pipelines/tasks/utility/command-line
==============================================================================
Generating script.
========================== Starting Command Output ===========================
/usr/bin/bash --noprofile --norc /home/azagent/_work/_temp/0328fe3e-e0d9-4ccf-89ec-c2b5ab134276.sh
CACHE: true DEPLOY: true
Finishing: Validating repository




UAT:
  ApplicationName: thirdPartyAAMAZE_sys
  IntegrationNode: 
  IntegrationServer:  
  Overrides:
    additionalInstances: 3

SIT: 
  ApplicationName: thirdPartyAAMAZE_sys
  IntegrationNode: 
  IntegrationServer: 
  Overrides:
    additionalInstances: 3

DEV: 
  ApplicationName: thirdPartyAAMAZE_sys
  IntegrationNode: PAYMENT_SYS
  IntegrationServer: Payment_S_03
  Deploy: false
  Overrides:
    additionalInstances: 4

  Cache:
    - Query: "INSERT into EISDEV.cache_details (FIELD_NAME, FIELD_VALUE, REQUEST_ACTION, PROCESSING_ACTION, RESPONSE_ACTION, SOURCE_ID, BACKEND_TYPE, BACKEND_SUB_TYPE, TRAN_CODE, SERVICE_NAME,CREATION_TIME) VALUES('IT_JVP_THINK360_SA_DOWNLOAD_REPORT_CONTENT_CHECK_CCSID_TEST01','Y','CONTENT_CHECK','SOURCE ID CONFIGURATION','NULL','MULTIPLE','THINK360','SA_DOWNLOAD_REPORT','IT_JVP','thirdPartyAAMAZE_sys',TRUNC(SYSDATE))"
      FIELD_NAME: "IT_JVP_THINK360_SA_DOWNLOAD_REPORT_CONTENT_CHECK_CCSID_TEST01"
      FIELD_VALUE: "Y"
    - Query: "INSERT into EISDEV.cache_details (FIELD_NAME, FIELD_VALUE, REQUEST_ACTION, PROCESSING_ACTION, RESPONSE_ACTION, SOURCE_ID, BACKEND_TYPE, BACKEND_SUB_TYPE, TRAN_CODE, SERVICE_NAME,CREATION_TIME) VALUES('IT_JVP_THINK360_SA_DOWNLOAD_REPORT_CCSID_TEST02','ST|Y2','SOURCE_ID','SOURCE ID CONFIGURATION','NULL','MULTIPLE','THINK360','SA_DOWNLOAD_REPORT','IT_JVP','thirdPartyAAMAZE_sys',TRUNC(SYSDATE))"
      FIELD_NAME: "IT_JVP_THINK360_SA_DOWNLOAD_REPORT_CCSID_TEST02"
      FIELD_VALUE: "ST|Y2"
PROD:
  ApplicationName:
  IntegrationNode:
  IntegrationServer:
  Overrides:
    additionalInstances: 3
