trigger:
  branches:
    include:
      - DEV
      - SIT
      - UAT
      - PRE-PROD
      - main

resources:
  repositories:
    - repository: shared
      type: git
      name: Azure-Pipelines
      ref: refs/heads/main

extends:
  template: templates/pipeline-template.yml@shared




stages:

# ================= BUILD STAGE =================
- stage: Build
  displayName: Build Stage
  jobs:
    - job: Build_Job
      displayName: Agent job 1
      pool:
        name: TFS-RH-1
      steps:
        - checkout: self

        - task: CmdLine@2
          displayName: Initialize Build Pipeline Variable
          env:
            BRANCH: $(Build.SourceBranchName)
          inputs:
            script: |
              set -e
              echo "Branch: $BRANCH"

              config_path=$(find . -name "config.yml")
              DEPLOY=$(yq e ".$BRANCH.Deploy" "$config_path" | tr -d '[:space:]')

              yq -i ".BRANCH = \"$BRANCH\"" "$config_path"

              if [ "$DEPLOY" = "false" ]; then
                echo "##vso[task.setvariable variable=DeployFlag]false"
              else
                echo "##vso[task.setvariable variable=DeployFlag]true"
              fi

        - task: CmdLine@2
          displayName: mqsipackagebar
          condition: eq(variables['DeployFlag'], 'true')
          env:
            BRANCH: $(Build.SourceBranchName)
            DeployFlag: $(DeployFlag)
          inputs:
            script: |
              set -e
              . /opt/IBM/ace/server/bin/mqsiprofile

              config_path=$(find . -name "config.yml")
              applicationName=$(yq e ".$BRANCH.ApplicationName" "$config_path")

              override_path=$(find . -iname "override.properties")

              if [ -f "$override_path" ]; then
                ibmint package --input-path $(Build.SourcesDirectory) \
                               --output-bar-file $(Build.SourcesDirectory)/_build/$applicationName.bar \
                               --java-version 8 \
                               --overrides-file "$override_path"
              else
                ibmint package --input-path $(Build.SourcesDirectory) \
                               --output-bar-file $(Build.SourcesDirectory)/_build/$applicationName.bar \
                               --java-version 8
              fi

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: $(Build.SourcesDirectory)/_build
            ArtifactName: drop


# ================= RELEASE STAGE =================
- stage: Release
  displayName: Deploy Stage
  dependsOn: Build
  jobs:
    - deployment: DeployApp
      displayName: Deployment Job
      environment: $(Build.SourceBranchName)
      pool:
        name: TFS-RH-1
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: drop

              - task: CmdLine@2
                displayName: Initialize Release Variables
                inputs:
                  workingDirectory: $(Pipeline.Workspace)/drop
                  script: |
                    set -e
                    config_path=$(find . -name "config.yml")

                    BRANCH=$(yq e '.BRANCH' "$config_path")
                    DEPLOY=$(yq e ".$BRANCH.Deploy" "$config_path" | tr -d '[:space:]')

                    if [ "$DEPLOY" = "false" ]; then
                      echo "##vso[task.setvariable variable=DeployFlag]false"
                    else
                      echo "##vso[task.setvariable variable=DeployFlag]true"
                    fi

                    CACHE_PRESENT=$(yq e ".$BRANCH.Cache // [] | length > 0" "$config_path")

                    if [ "$CACHE_PRESENT" = "true" ]; then
                      echo "##vso[task.setvariable variable=CacheFlag]true"
                    else
                      echo "##vso[task.setvariable variable=CacheFlag]false"
                    fi

              - task: CmdLine@2
                displayName: Deployment
                condition: eq(variables['DeployFlag'], 'true')
                inputs:
                  workingDirectory: $(Pipeline.Workspace)/drop
                  script: |
                    set -e
                    . /opt/IBM/ace/server/bin/mqsiprofile

                    config_path=$(find . -name "config.yml")
                    BRANCH=$(yq e '.BRANCH' "$config_path")

                    IntegrationNode=$(yq e ".$BRANCH.IntegrationNode" "$config_path")
                    ApplicationName=$(yq e ".$BRANCH.ApplicationName" "$config_path")
                    IntegrationServer=$(yq e ".$BRANCH.IntegrationServer" "$config_path")

                    bar_path=$(find . -name "$ApplicationName.bar")

                    for broker_file in /home/devops/broker/$BRANCH/$IntegrationNode*; do
                      ibmint deploy \
                        --input-bar-file "$bar_path" \
                        --integration-node-file "$broker_file" \
                        --output-server "$IntegrationServer"
                    done




