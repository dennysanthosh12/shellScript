package com.EIS.TCS.apiadmin.Utility;
import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
	
	@Autowired
	private JwtService jwtService;
	
	@Autowired
	private UserDetailsService userDetailsService;
	
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) 
            throws ServletException, IOException {
        String authHeader = request.getHeader("Authorization");
        
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        String jwt = authHeader.substring(7);
        String username = jwtService.extractUsername(jwt);

        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            
            if (jwtService.isTokenValid(jwt, userDetails)) {
                // Ensure authorities from the token/DB are passed here
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}



mysql -ueisuat -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2040
Server version: 8.0.44 Source distribution

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> use UAT_DB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+------------------+
| Tables_in_UAT_DB |
+------------------+
| role             |
| user             |
| user_roles       |
+------------------+
3 rows in set (0.00 sec)

mysql> select * from user;
+----+--------------------------------------------------------------+----------+
| id | password                                                     | username |
+----+--------------------------------------------------------------+----------+
|  1 | $2a$10$ou2vbQ4UAU1gNRMI4M58ourY.i8irrWS1iKqPTfygn7Zs2Fxsmrju | Denny    |
|  2 | $2a$10$3CBKF.UUBQHMdnybxUTwruvm.dJpEOPh37ALBpPZDAbswmv5oMjZ6 | Adil     |
|  3 | $2a$10$mQv1nC9u4xHpBZx4ogIhHuOZvFY9CKKIAZqXA7weUggqYAOSJ.dBq | gautam   |
+----+--------------------------------------------------------------+----------+
3 rows in set (0.00 sec)

mysql> select * from user_role;
ERROR 1146 (42S02): Table 'UAT_DB.user_role' doesn't exist
mysql> select * from user_roles;
+---------+---------+
| user_id | role_id |
+---------+---------+
|       1 |       1 |
|       2 |       1 |
|       3 |       1 |
+---------+---------+
3 rows in set (0.00 sec)

mysql> select * from role;
+----+------------+
| id | role       |
+----+------------+
|  1 | ROLE_USER  |
|  2 | ROLE_ADMIN |
+----+------------+
2 rows in set (0.00 sec)

mysql> exit
Bye
[eisuser@eisuatsftp01 Denny]$


