@Entity
@Table(name = "integration_status")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class IntegrationStatus {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "node_name", length = 50, nullable = false)
    private String nodeName;

    @Column(name = "status", length = 20, nullable = false)
    private String status;

    @Column(name = "last_checked", nullable = false)
    private LocalDateTime lastChecked;

    @Column(name = "response", columnDefinition = "json")
    private String response;   // JSON as String
}

@Repository
public interface IntegrationStatusRepository
        extends JpaRepository<IntegrationStatus, Long> {
}

@Service
@RequiredArgsConstructor
public class IntegrationStatusService {

    private final IntegrationStatusRepository statusRepository;
    private final ObjectMapper objectMapper;

    public void saveStatus(IntegrationEndpoint ep,
                           IntegrationNodeResponse response) {

        try {
            String jsonResponse =
                    objectMapper.writeValueAsString(response);

            IntegrationStatus status = IntegrationStatus.builder()
                    .nodeName(ep.getNodeName())
                    .status("UP")
                    .lastChecked(LocalDateTime.now())
                    .response(jsonResponse)
                    .build();

            statusRepository.save(status);

        } catch (Exception e) {
            // fallback if JSON conversion fails
            saveFailure(ep, e);
        }
    }


    public void saveFailure(IntegrationEndpoint ep, Throwable ex) {

        IntegrationStatus status = IntegrationStatus.builder()
                .nodeName(ep.getNodeName())
                .status("DOWN")
                .lastChecked(LocalDateTime.now())
                .response(buildErrorJson(ex))
                .build();

        statusRepository.save(status);
    }

    private String buildErrorJson(Throwable ex) {
        return String.format(
                "{\"error\":\"%s\",\"message\":\"%s\"}",
                ex.getClass().getSimpleName(),
                ex.getMessage()
        );
    }
}




