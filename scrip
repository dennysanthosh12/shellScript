package com.EIS.TCS.apiadmin.Services;

import java.time.LocalDateTime;
import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import com.EIS.TCS.apiadmin.Dto.IntegrationNodeWrapper;
import com.EIS.TCS.apiadmin.Model.IntegrationStatus;
import com.EIS.TCS.apiadmin.Model.NodeEndpoint;
import com.EIS.TCS.apiadmin.Repository.EndpointRepository;
import com.EIS.TCS.apiadmin.Repository.IntegrationStatusRepository;
import lombok.RequiredArgsConstructor;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.core.scheduler.Schedulers;

@Service
@RequiredArgsConstructor
public class IntegrationPollingService {

	@Autowired
	private IntegrationStatusRepository statusRepository;
	
	@Autowired
	private WebClient webClient;
	
	@Autowired
	private EndpointRepository endpointRepo;
	
	public Mono<Void> pollAllNodes() {

        List<NodeEndpoint> endpoints =
                endpointRepo.findByActiveTrue();

        return Flux.fromIterable(endpoints)
                .parallel()
                .runOn(Schedulers.boundedElastic())
                .flatMap(this::callAceApi)
                .sequential()
                .then();
    }
	
	private Mono<Void> callAceApi(NodeEndpoint ep) {

        String url = String.format(
                "%s://%s:%d/apiv2",
                ep.getProtocol(), ep.getHost(), ep.getPort());

        return webClient.get()
                .uri(url)
                .retrieve()
                .bodyToMono(IntegrationNodeWrapper.class)
                .doOnNext(resp -> saveStatus(ep, resp))
                .then();
    }
	
	public void saveStatus(NodeEndpoint ep,IntegrationNodeWrapper response) {


			IntegrationStatus status = new IntegrationStatus(response.getName(),ep.getHost(),"UP",LocalDateTime.now(),response);
			statusRepository.save(status);

}
}




package com.EIS.TCS.apiadmin.Services;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import lombok.RequiredArgsConstructor;

@EnableScheduling
@Component
@RequiredArgsConstructor
public class IntegrationScheduler {

	@Autowired
	private final IntegrationPollingService pollingService;

    @Scheduled(fixedRate = 10000)
    public void pollIntegrationNodes() {
        pollingService.pollAllNodes().subscribe();
    }
}


package com.EIS.TCS.apiadmin.Configurations;
import java.time.Duration;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.web.reactive.function.client.WebClient;

import reactor.netty.http.client.HttpClient;

@Configuration
public class WebClientConfig {

	
	@Bean
	public WebClient aceWebClient() {
		return WebClient.builder()
				.clientConnector(new ReactorClientHttpConnector(
						HttpClient.create()
						.responseTimeout(Duration.ofSeconds(5))))
				.build();
	}
}
